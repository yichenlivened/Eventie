"use strict";$(document).ready(function(){$.fn.serializeObject=function(){var e={},t=this.serializeArray();return $.each(t,function(){e[this.name]?(e[this.name].push||(e[this.name]=[e[this.name]]),e[this.name].push(this.value||"")):e[this.name]=this.value||""}),e},String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)};var homeModel,homeController,homeView,navController,navView,requirementModel,modalSignup;homeModel={config:{apiKey:"AIzaSyCxRkGJI20d-SRzTlFYnmU94Jnfj7oCJbw",authDomain:"scorching-fire-2347.firebaseapp.com",databaseURL:"https://scorching-fire-2347.firebaseio.com",storageBucket:"scorching-fire-2347.appspot.com"}},homeController={init:function(){firebase.initializeApp(homeModel.config),homeView.init()}},homeView={init:function(){firebase.database().ref("events/").once("value").then(function(e){$("#showEvent").html(""),$.each(e.val(),function(e,t){$("#showEvent").append('<div class="col-xs-12 col-md-6"><div class="thumbnail"><div class="caption"><p>'+t.start+"</p><h3>"+t.title+"</h3><p>"+t.location+"</p></div></div></div>")})})}},homeController.init(),navController={init:function(){navView.init()},signOut:function(){firebase.auth().signOut().then(function(){console.log("logout")},function(e){console.log(e)})}},navView={init:function(){this.headerLoginBtn=$("#headerLoginBtn"),this.headerSignupBtn=$("#headerSignupBtn"),this.headerUserBtn=$("#headerUserBtn"),this.headerUsername=$("#headerUsername"),this.headerLogoutBtn=$("#headerLogoutBtn"),this.createEventBtn=$("#createEventBtn")},render:function(e){var t=this;e?(firebase.database().ref("/users/"+e.uid).once("value").then(function(e){t.headerLoginBtn.addClass("hide"),t.headerSignupBtn.addClass("hide"),t.headerUsername.text("Hi, "+e.val().username).append('<span class="caret"></span>'),t.headerUserBtn.removeClass("hide")}),t.headerLogoutBtn.click(function(){navController.signOut()}),t.createEventBtn.off("click"),t.createEventBtn.click(function(){console.log(modalCreateEvent.view.modal),modalCreateEvent.view.modal.modal("show")})):(console.log("no user"),t.headerLoginBtn.removeClass("hide"),t.headerSignupBtn.removeClass("hide"),t.headerUserBtn.addClass("hide"),t.createEventBtn.off("click"),t.createEventBtn.click(function(){modalSignUp.view.modal.modal("show")}))}},navController.init(),firebase.auth().onAuthStateChanged(function(e){navView.render(e)}),requirementModel={nameRequirement:[{condition:'value == ""',output:"Please enter your name."},{condition:"value.length < 8",output:"Your name should be greater than 8 characters."},{condition:"value.length > 30",output:"Your name should be fewer than 30 characters."}],jobRequirement:[{condition:"value.length > 20",output:"Your job name should be fewer than 20 characters."}],emailRequirement:[{condition:'value == ""',output:"Please enter your email."},{condition:"!construct.validateEmail(value)",output:"Your email format is not right."},{condition:"value.length > 100",output:"Your email should be fewer than 100 characters."}],passwordRequirement:[{condition:'value == ""',output:"Please enter your password."},{condition:"value.length < 3",output:"Your password should be greater than 3 characters."},{condition:"value.length > 20",output:"Your password should be fewer than 20 characters."}],titleRequirement:[{condition:'value == ""',output:"Please enter the event title."},{condition:"value.length < 3",output:"Your title should be greater than 3 characters."},{condition:"value.length > 20",output:"Your title should be fewer than 20 characters."}],typeRequirement:[{condition:'value == "Select the type of the event"',output:"Please select the type of the event."}],hostRequirement:[{condition:'value == ""',output:"Please enter the event host."},{condition:"value.length < 3",output:"The event host should be greater than 3 characters."},{condition:"value.length > 20",output:"The event host should be fewer than 20 characters."}],startRequirement:[{condition:'value == ""',output:"Please enter the event start time."}],endRequirement:[{condition:'value == ""',output:"Please enter the event end time."}],locationRequirement:[{condition:'value == ""',output:"Please enter the event location."},{condition:"value.length < 3",output:"The event location should be greater than 3 characters."},{condition:"value.length > 50",output:"The event location should be fewer than 50 characters."}],guestRequirement:[{condition:'value == ""',output:"Please enter the event guest."},{condition:"value.length < 3",output:"The event guest should be greater than 3 characters."},{condition:"value.length > 20",output:"The event guest should be fewer than 20 characters."}],messageRequirement:[{condition:"value.length > 100",output:"The event message should be fewer than 100 characters."}]};var ConstructForm=function ConstructForm(modalName,inputList,type){var construct=this;this.controller={init:function(){construct.view.init()},clean:function(){inputList.forEach(function(e){construct.view[e].val("")})},getVal:function(e){return construct.view[e].val()},check:function check(varName){for(var value=this.getVal(varName),result="",requirement=requirementModel[varName+"Requirement"],i=0;i<requirement.length;i++)if(eval(requirement[i].condition)){result=requirement[i].output;break}if("start"==varName){value=new Date(value);var dateNow=new Date;dateNow>value&&(result="Start day should be after"+dateNow)}if("end"==varName){value=new Date(value);var start=new Date(this.getVal("start"));""==this.getVal("start")&&(result="Please enter start day."),start>value&&(result="End day should be after start day:"+start)}return result},createUser:function(e,t,n,a){var o=this;firebase.auth().createUserWithEmailAndPassword(n,a).then(function(n){o.writeUserData(n.uid,e,t),console.log("successfully created the user."),console.log(n),construct.view.modal.modal("hide")})["catch"](function(e){var t=e.code;alert(t)})},writeUserData:function(e,t,n){firebase.database().ref("users/"+e).set({username:t,job:n})},login:function(e,t){firebase.auth().signInWithEmailAndPassword(e,t).then(function(e){console.log(e),construct.view.modal.modal("hide")})["catch"](function(e){var t=e.message;alert(t)})},createEvent:function(e,t,n,a,o,i,r,s){function u(u){var l={title:e,type:t,host:n,start:a,end:o,location:i,guest:r,message:s},c=firebase.database().ref().child("posts").push().key,h={};return h["/events/"+c]=l,h["/users/"+u+"/events/"+c]=l,firebase.database().ref().update(h)}var l=firebase.auth().currentUser;u(l.uid).then(function(){construct.controller.clean(),construct.view.modal.modal("hide"),homeView.init()})}},this.view={modalName:modalName,inputList:inputList,error:[],init:function(){var e=this;this.modal=$("#"+modalName),inputList.forEach(function(t){e[t]=$("#"+modalName+t.capitalizeFirstLetter()),e.addCheck(e[t],t)}),this.modalSubmitBtn=this.modal.find("button[type=submit]"),this.submit(e.modalSubmitBtn,type),this.focus(inputList[0]),"signup"==type&&(this.link=this.modal.find(".link-login"),this.link.click(function(){e.modal.modal("hide"),modalLogin.view.modal.modal("show")}))},alert:function(e,t){var n='<div role="alert" class="alert alert-'+e+'"><span class="alert-link">'+t+"</span></div>";return n},focus:function(e){var t=this;t.modal.on("shown.bs.modal",function(){t[e].focus()})},cleanError:function(){this.error=[]},addCheck:function(e,t){var n=this;e.blur(function(a){a.preventDefault(),n.check(e,t)})},check:function(e,t){var n=this,a=construct.controller.check(t);""==a?e.parent().find(".alert").remove():(n.error.push(t),e.parent().find(".alert").remove(),e.parent().append(n.alert("danger",a)))},submit:function(e,t){var n=this,a=construct.controller;e.click(function(e){e.preventDefault(),n.cleanError(),n.inputList.forEach(function(e){n.check(n[e],e)}),0==n.error.length?(console.log("submit"),"signup"==t&&a.createUser(a.getVal("name"),a.getVal("job"),a.getVal("email"),a.getVal("password")),"login"==t&&a.login(a.getVal("email"),a.getVal("password")),"createEvent"==t&&a.createEvent(a.getVal("title"),a.getVal("type"),a.getVal("host"),a.getVal("start"),a.getVal("end"),a.getVal("location"),a.getVal("guest"),a.getVal("message"))):n[n.error[0]].focus()})}},this.start=function(){this.controller.init()}};ConstructForm.prototype.validateEmail=function(e){var t=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return t.test(e)};var modalSignUp=new ConstructForm("modalSignup",["name","job","email","password"],"signup");modalSignUp.start();var modalLogin=new ConstructForm("modalLogin",["email","password"],"login");modalLogin.start();var modalCreateEvent=new ConstructForm("modalCreateEvent",["title","type","host","start","end","location","guest","message"],"createEvent");modalCreateEvent.start()});